---
title: "twitter"
author: "Simon Roth"
date: "26 Januar 2018"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
pacman::p_load(tidyverse, wdman, jsonlite, rvest, xml2, RSelenium, here)
```

# reading twitter ids

```{r}
# 
# tweet_ids <- dir(here("data", "tw"))[-1:-2]
# 
# 
# handlers <- c("RealAlexJones", "AnnCoulter", "ArktosMedia", "MsBlaireWhite", "navyhato", "BreitbartNews", "Cernovich", "CNN", "NewRightAmerica", "scrowder", "IdentityEvropa", "FoxNews", "Gavin_McInnes" , "infowars", "Lauren_Southern",  "StefanMolyneux", "MSNBC", "MillennialWoes", "nytimes", "AVoiceforMen", "BrittPettibone", "PrisonPlanet", "ramzpaul",  "TheRebelTV", "redicetv", "ReturnOfKings", "RichardBSpencer", "RoamingMil","TRobinsonNewEra", "Styx666Official","vdare", "washingtonpost")
# 
# cbind(tweet_ids, handlers)
# 
# tweet_init <- fromJSON(here("data", "tw", "tw_abc_ids.json")) %>% 
#   data.frame(handler = "ABC")
# for (jj in seq_along(tweet_ids)) {
#    tweet_init <- plyr::rbind.fill(tweet_init, 
#                                   jsonlite::fromJSON(
#                                     here(
#                                     "data", "tw", tweet_ids[jj]
#                                     )
#                                   ) %>% 
#                                   data.frame(handler = handlers[jj]))
#    cat(jj, "\n")
# }
# handler_ids <- tweet_init
# 
# colnames(handler_ids) <- c("tweet_id", "handler")
# 
# save(handler_ids, file = here("data", "tw", "handler_ids.Rdata"))
# 


load(here("data", "tw", "handler_ids.Rdata"))
table(handler_ids$handler)
```

```{r}
#  library(twitteR)
#  consumer_key <- "itt4vjXXihsdZAIEK48rK1XOR"
#  consumer_secret <- "gIHdZX9ecZoP5i0k6zkPBZb2WuMvPYHYFQUPqCO4KXMO1EULWE"
#  options(httr_oauth_cache=T)
#  twitteR::setup_twitter_oauth(consumer_key, consumer_secret)
# 
# 
# userName <- handler_ids$handler
# # 
# # id <- an_ids[length(an_ids)]
# 
# # twitteR::showStatus(id)
# # lookup_statuses(an_ids[1:10])
# 
# tw_everytweet <- rtweet::lookup_tweets(handler_ids$tweet_id)
# save(tw_everytweet, file = "data/tw_everytweet.Rdata")
# glimpse(every_tweet)

# anncoulter_tweets$created_at %>%
#   range

# url_str <- "https://twitter.com/anncoulter/status/834217566126108673?lang=en"
# 
# html_file <- xml2::read_html(url_str) 
```




# Rselenium

```{r}
library(RSelenium)
port <- sample(4000L:5000L, 1)
rD <- rsDriver(verbose = FALSE, port = port)
rD

remDr <- rD$client
#remDr$close()
```



#  Helper

first loop

```{r}
get_replies <- function(html) {
  
  if_notnull <- function(x) ifelse(identical(x, character(0)) | is.null(x), NA, x)
  
  html_list <- html %>% 
    html_nodes(".permalink-descendant-tweet , .js-initial-focus") ##stream-items-id
  
  storage <- data.frame()
  
  for(jj in seq_along(html_list)){
  
    names <- html_list[jj] %>%
      html_nodes(".js-nav .u-textTruncate b") %>%
      html_text() 
    if(is.null(names)) names <- NA
  
    text <- html_list[jj] %>%
      html_nodes(".tweet-text") %>%
      html_text() 
    if(is.null(text)) text <- NA
    
    dates <- html_list[jj] %>%
      html_nodes(".js-short-timestamp") %>%
      html_text() 
    if(is.null(dates)) dates <- NA
  
    favorites <- html_list[jj] %>%
      html_nodes(".js-actionFavorite .ProfileTweet-actionCountForPresentation") %>%
      html_text() %>%
      as.numeric() %>%
      ifelse(is.na(.), 0, .)
    if(is.null(favorites)) favorites <- NA
      
    retweets <- html_list[jj] %>%
      html_nodes(".js-actionRetweet .ProfileTweet-actionCountForPresentation") %>%
      html_text() %>%
      as.numeric() %>%
      ifelse(is.na(.), 0, .)
    if(is.null(retweets)) retweets <- NA
    
    comments <-  html_list[jj] %>%
      html_nodes(".js-actionReply .ProfileTweet-actionCountForPresentation") %>%
      html_text() %>%
      as.numeric() %>%
      ifelse(is.na(.), 0, .)
    if(is.null(comments)) comments <- NA
  
    replies <- data.frame(
      names, dates, text, 
      favorites, retweets, comments, 
      stringsAsFactors = F
    )
    
    storage <- rbind(storage, replies)
  }
  
  return(storage)
}
```


# Main Function

second loop

* scroller](https://stackoverflow.com/questions/45204934/check-if-its-possible-to-scroll-down-with-rselenium)


```{r}
library(rvest)

ntweets <- function(){
  ntweets <- remDr$getPageSource()[[1]] %>% 
    read_html() %>%
    html_nodes(".js-nav .u-textTruncate b") %>%
    html_text() %>% 
    length()
}


get_replies_df <- function(handle, ids) {

  ### scroller script
  css_element <- "#permalink-overlay-dialog > div.PermalinkOverlay-content > div > div > div.permalink-footer" # target element
  script <- "arguments[0].scrollIntoView(true);" # scroller function
  
  ### prep
  u <- paste0("https://twitter.com/", handle, "/status/", ids, "?lang=en")
  replies <- list()
  
  for(jj in seq_along(u)) {
   
    # call twitter url
    remDr$navigate(u[jj])
    
    ### scroller
    k <- 50
    ntw_before <- ntweets()
    
    while(k > 0){
      tryCatch({
        # scroll

        webElem <- remDr$findElement("css", css_element)
        remDr$executeScript(script, args = list(webElem))
        Sys.sleep(1.5)
        
        ntw_after <- ntweets()

        
        if(ntw_before == ntw_after) {
          k <- 0
        } else {
          k <- k - 1
          ntw_before <- ntw_after
        }

        cat("\n", k, " scrolls remain\n")
      }, error = function(e){
        k <- 0
      })
    }

    tryCatch({
      replies[[jj]] <- remDr$getPageSource()[[1]] %>% 
      xml2::read_html() %>%
      get_replies()
    }, error = function(e){
      replies[[jj]] <- NA
      cat("sorry not found.")
    })

    #cat(jj, "\t")
  }
  
  replies <- do.call("rbind", replies)
  if(!is.null(replies)) replies$handle <- handle
     # save(replies, file = "data/replies.Rdata")
  return(replies)
}
```

third loop

```{r}
dat <- handler_ids

#handle <- dat$handler[8]
#ids <- dat$tweet_id[8]


start <- 1
final <- list()

for (jj in start:nrow(dat)) {
  rd <- get_replies_df(dat$handler[jj], dat$tweet_id[jj])
  
  file_exists <- file.exists(paste0("data/replies_list", "_", start, "_", jj - 1, ".Rdata"))
  is_available <- (!is.data.frame(rd) | !is.null(rd))
  
  if (is_available) {
    if(file_exists) file.remove(paste0("data/replies_list", "_", start, "_", jj - 1, ".Rdata"))
    final[[jj]] <- rd
    save(final, file = paste0("data/replies_list", "_", start, "_", jj, ".Rdata"))

  }

  cat("Tweet Number:", jj, "By:", handler[jj])
}

final_dt <- bind_rows(final) %>%
  ## extract unique elements
  filter(!duplicated(text))
beepr::beep(8)
save(final_dt, file = "data/replies.Rdata")
```

